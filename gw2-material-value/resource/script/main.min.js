(function(t){var n=["ui_coin_gold","ui_coin_silver","ui_coin_copper"],a=[],e=50,i=function(){c(!1),s(),o(""),l(!1)},o=function(n){var a=t("#status");a.html(n)},l=function(n){var a=t("#loader");n?(u(0),a.show()):(u(0),a.hide())},u=function(n){var a=t("#loader .progress-bar");a.css({width:n+"%"})},r=function(n){var a=t("#materials-table tbody"),e=n.price.buys.unit_price,i=n.price.sells.unit_price,o=n.count*e,l=n.count*i;t("<tr/>").append('<td><img src="'+n.itemInfo.icon+'"/></td>').append('<td data-value="'+n.itemInfo.name+'">'+n.itemInfo.name+"</td>").append('<td data-value="'+n.count+'">'+n.count+"</td>").append('<td data-value="'+e+'">'+y(e)+"</td>").append('<td data-value="'+i+'">'+y(i)+"</td>").append('<td data-value="'+o+'">'+y(o)+"</td>").append('<td data-value="'+l+'">'+y(l)+"</td>").data("unitBuy",e).data("unitSell",i).data("totalBuy",o).data("totalSell",l).appendTo(a),d()},c=function(n){var a=t("#materials-table");n?a.show():a.hide()},d=function(){var n=t("#sum"),a=t("#materials-table tbody"),e=t("#sum-total-min"),i=t("#sum-total-max"),o=0,l=0;a.find("tr").each(function(){o+=t(this).data("totalBuy"),l+=t(this).data("totalSell")}),e.html(y(o)),i.html(y(l)),0!==l||0!==o?n.show():n.hide()},s=function(){var n=t("#materials-table tbody"),a=t("#sum-total-min"),e=t("#sum-total-max");n.html(""),a.html(""),e.html("")},f="https://api.guildwars2.com/v2",m=f+"/items",h=f+"/account",p=h+"/materials",g=f+"/commerce",v=g+"/prices",_=f+"/files",y=function(t){var n=t,e=Math.floor(n/1e4);n-=1e4*e;var i=Math.floor(n/100);n-=100*i;var o="<img data-asset='ui_coin_gold' alt='Gold' />",l="<img data-asset='ui_coin_silver' alt='Silver' />",u="<img data-asset='ui_coin_copper' alt='Copper' />";a.ui_coin_gold&&(o="<img src='"+a.ui_coin_gold+"' alt='Gold' />"),a.ui_coin_silver&&(l="<img src='"+a.ui_coin_silver+"' alt='Silver' />"),a.ui_coin_copper&&(u="<img src='"+a.ui_coin_copper+"' alt='Copper' />");var r=e+o+i+l+n+u;return r},b=function(t,n){jQuery.ajax({url:m+"/"+t}).done(function(t){n(t)}).fail(function(t,n){console.error("Request failed: "+n)})},w=function(t,n){jQuery.ajax({url:p+"?access_token="+t}).done(function(t){n(t)}).fail(function(t,n){console.error("Request failed: "+n)})},j=function(t,n){jQuery.ajax({url:v+"/"+t}).done(function(t){n(t)}).fail(function(t,n){console.error("Request failed: "+n)})},I=function(t,n,a){if(u(100*n.length/(t.length+n.length)),t.length){var i=t.shift();setTimeout(function(){b(i.id,function(e){i.itemInfo=e,n.push(i),I(t,n,a)})},e)}else a(n)},x=function(t,n,a){if(u(100*n.length/(t.length+n.length)),t.length){var i=t.shift();setTimeout(function(){j(i.id,function(e){i.price=e,n.push(i),r(i),x(t,n,a)})},e)}else a(n)},S=function(t,n,a){if(t.length){var i=t.shift();jQuery.ajax({url:_+"/"+i}).done(function(o){n[i]=o.icon,setTimeout(function(){S(t,n,a)},e)}).fail(function(t,n){console.error("Request failed: "+n)})}else a(n)},k=function(){S(n,a,function(n){t("img").each(function(){var a=t(this);"string"==typeof a.data("asset")&&""!==a.data("asset")&&(a.attr("src",n[a.data("asset")]),a.data("asset",""))})})};t(window).on("load",function(){k(),t("#get-form").submit(function(n){n.preventDefault(),i();var a=t("#get-form"),e=a.find('[name="api-key"]').val();if(e.length){o("Loading account materials..."),w(e,function(t){o("Found "+t.length+" materials. Loading data ..."),t=t.filter(function(t){return("undefined"==typeof t.binding||"Account"!==t.binding)&&("undefined"==typeof t.count||0!==t.count)}),o("Found "+t.length+" relevant materials. Loading additional item information (this may take a while) ..."),l(!0),I(t,[],function(n){l(!1),t=n.filter(function(t){for(var n=0;n<t.itemInfo.flags.length;n++)if("AccountBound"===t.itemInfo.flags[n]||"NoSell"===t.itemInfo.flags[n])return!1;return!0}),o("Loading price information for "+t.length+" sellable items (this may take a while, as well) ..."),l(!0),x(t,[],function(t){l(!1),o(""),c(!0)})})})}else o("Please enter your API Key")}),t("th[data-sort-column]").on("click touchstart",function(n){n.stopImmediatePropagation();var a=t(this),e=a.data("sortColumn"),i=a.closest("table").find("tbody"),o=i.find("tr"),l=[];o.each(function(){var n=t(this);l.push(n)}),l=l.sort(function(t,n){var a=t.find("td:nth-of-type("+e+")").data("value"),i=n.find("td:nth-of-type("+e+")").data("value");return a<i?1:i<a?-1:0}),i.html("");for(var u=0;u<l.length;u++)i.append(l[u])})})})(jQuery);